---
title: "Assignment 3: Linear Mixed Effects Models"
author: "Tamar Gazit (B00842040)"
format: html
editor: visual
---

## Data Preparation

```{r}
# -------------------------------------------
# 1. Load packages
# -------------------------------------------
library(haven)         # For reading in SPSS files
library(tidyverse)     # For data manipulation and whatnot
library(flexplot)      # For visualizations and diagnostics
library(lme4)          # For mixed effects models
library(performance)   # For ICC, R2
library(apaTables)     # For APA-style descriptive/correlation table
library(psych)         # For descriptive statistics
library(broom.mixed)   # For model summaries

# -------------------------------------------
# 2. Load & prepare data
# -------------------------------------------
data <- read_sav("P6003.A4.sav") %>%
  mutate(
    id = as.factor(id),      # Converts participant ID into a factor (categorical)
    day = as.numeric(day))   # Ensures 'day' is treated as a numeric variable

# Rationale:
# - This section prepares the dataset for analysis by ensuring variables have the correct data types.
# - Treating 'id' as a factor is essential for nesting repeated observations in mixed-effects 
#   models.
# - Ensuring 'day' is numeric would be necessary if modeling time effects or examining trends 
#   over days.

# Look at/explore the dataset
head(data)

# NOTE. We have 4252 observations of 19 variables. The dataset is already in long format.
```

## Data Exploration

#### Descriptives & Bivariate Correlations

```{r}
# -----------------------------------------------
# 3. Descriptives and correlations for raw data
# -----------------------------------------------

vars <- data %>% select(swl, tipm.E, tipm.N)  
# Selects the three key variables:
# swl = Satisfaction With Life (outcome variable)
# tipm.E = Extraversion (predictor for H1)
# tipm.N = Neuroticism (predictor for H2)

names(vars) <- c("Satisfaction with Life", "Extraversion", "Neuroticism")  
# Renames variables to improve readability in tables and output

describe(vars)  
# Provides descriptive statistics for each variable (mean, SD, skew, kurtosis, etc.)
# Useful for checking distribution shape and identifying possible outliers or violations of normality

apa.cor.table(vars, filename = "Table1_APA_Descriptives.doc")  
# Generates an APA-style correlation table between all three variables
# Automatically saves the table as a .doc file for my write-up
# Helps provide preliminary support for H1 and H2

```

#### Univariate and Bivariate Visualizations

```{r}
# -------------------------------------------
# 4A. Univariate visualizations
# -------------------------------------------

# Univariate plots: visualize distributions of each variable
flexplot(swl ~ 1, data = data) +             # Histogram of SWL
  flexplot(tipm.E ~ 1, data = data) /        # Histogram of Extraversion
  flexplot(tipm.N ~ 1, data = data)          # Histogram of Neuroticism

# Quick interpretation
#   - SWL is slightly left skewed. Many participants report high life satisfaction
#   - Extraversion looks roughly normal. Maybe slight right skew
#   - Neuroticism is right skewed. More people score low on neuroticism
#   - No obvious outliers or strong floor/ceiling effects. Great!


# -------------------------------------------
# 4B. Bivariate visualizations
# -------------------------------------------

# Bivariate plots: examine linear relationships between predictors and outcome
flexplot(swl ~ tipm.E, data = data) +        # Tests H1 visually: is Extraversion positively related to SWL?
  flexplot(swl ~ tipm.N, data = data)        # Tests H2 visually: is Neuroticism negatively related to SWL?

# Quick interpretation
#   - SWL increases with extraversion (positive linear trend)
#   - SWL decreases with neuroticism (negative linear trend)
#   - Visual support for both H1 and H2!
#   - No major nonlinearity or weird clusters.

```

#### Fit Baseline Model and Compute Intraclass Coefficient Coefficient (ICC)

```{r}
# -------------------------------------------
# 5. Fit baseline model & compute ICC
# -------------------------------------------

baseline <- lmer(swl ~ 1 + (1 | id), data = data)  
summary(baseline)
# Fits a null (intercept-only) mixed effects model with random intercepts for participants
# This model assumes that each participant has their own baseline level of SWL
# No predictors are included yet

flexplot::icc(baseline)  
# Calculates the ICC and design effect
# ICC = proportion of variance in SWL explained by differences between participants
# Design effect > 2 suggests multilevel modeling is preferred due to clustering
# Supports justification for mixed-effects modeling

# Quick interpretation
#   - ICC = 0.74, meaning 74% of the variance in SWL is due to between-person differences
#   - Design effect = 12.30 provides strong evidence that observations are not independent
#   - Results definitely justify the use of multilevel modeling to account for clustering by 
#     participant
```

#### Assumption Check

```{r}
# -------------------------------------------
# 6. Assumption Check: Random Intercepts Model
# -------------------------------------------

# Fit a basic model with fixed effects for extraversion and neuroticism, and random intercepts for participant ID
model_diagnostics <- lmer(swl ~ tipm.E + tipm.N + (1 | id), data = data)  

# Prepare residual and fitted values for diagnostics
resid_data <- model.frame(model_diagnostics) %>%
  mutate(
    resid = residuals(model_diagnostics),   # Raw residuals
    fitted = fitted(model_diagnostics)      # Model-predicted values
  )

# -----------------------------
# A. Residuals vs. Predictors
# -----------------------------

# Check linearity and homoscedasticity for extraversion
flexplot(resid ~ tipm.E, data = resid_data) 
# Residuals appear randomly scattered across the range of extraversion
# No strong curvature or funneling. Assumptions met

# Check linearity and homoscedasticity for neuroticism
flexplot(resid ~ tipm.N, data = resid_data)  
#️ Minor downward trend. Slight non-linearity
# Still centered and roughly symmetric. Not a serious violation

# --------------------------------------
# B. Distribution & Normality of Residuals
# --------------------------------------

# Histogram of residuals
flexplot(resid ~ 1, data = resid_data)       
# Roughly bell-shaped distribution. Supports normality assumption

# Q-Q plot for normality
qqnorm(resid_data$resid); qqline(resid_data$resid, col = "red")  
# Most points follow the line
#️ Slight deviation at tails is supposedly typical in large samples, not concerning

# --------------------------------------
# C. Residuals vs. Fitted Values
# --------------------------------------

# Final check for non-linearity and heteroscedasticity
ggplot(resid_data, aes(fitted, resid)) +
  geom_point(alpha = 0.3) +                 
  geom_smooth(method = "loess") +           
  labs(title = "Residuals vs Fitted", x = "Fitted Values", y = "Residuals") +
  theme_minimal()
# Slight curvature and some fanning. Mild heteroscedasticity
#️ Not sure its extreme enough to invalidate the model

# --------------------------------------
# Summary
# --------------------------------------
# - Assumptions are reasonably met overall
# ️- Minor non-linearity and heteroscedasticity noted, but no major red flags
# ️- Good enough to proceed to more complex models

```

## Testing H1 and H2: Model Building

```{r}
# -------------------------------------------
# Model 1: Fixed slope for Extraversion only
# -------------------------------------------
model1 <- lmer(swl ~ tipm.E + (1 | id), data = data)
summary(model1)

# Interpretation:
# Extraversion significantly predicted life satisfaction (b = 0.23, SE = 0.01, t = 19.52).
# Participants higher in extraversion reported greater SWL, on average.
# Supports H1.


# -------------------------------------------
# Model 2: Random slope for Extraversion
# -------------------------------------------
model2 <- lmer(swl ~ tipm.E + (tipm.E | id), data = data)
summary(model2)

# Interpretation:
# Extraversion remained a significant predictor (b = 0.23, SE = 0.02, t = 13.56).
# The slope for extraversion varied across participants (SD = 0.18),
# Suggests person-level differences in how extraversion relates to SWL.


# -------------------------------------------
# Model 3: Add fixed effect for Neuroticism
# -------------------------------------------
model3 <- lmer(swl ~ tipm.E + tipm.N + (tipm.E | id), data = data)
summary(model3)

# Interpretation:
# Both extraversion (b = 0.16, SE = 0.02, t = 9.83) and neuroticism (b = -0.22, SE = 0.01, t = -19.86) significantly predicted SWL.
# Higher extraversion and lower neuroticism were each independently associated with greater SWL.
# Supports H1 and H2.


# -------------------------------------------
# Model 4: Random slopes for Extraversion and Neuroticism
# -------------------------------------------
model4 <- lmer(swl ~ tipm.E + tipm.N + (tipm.E + tipm.N | id), data = data)
summary(model4)

# Interpretation:
# Both predictors remained significant (extraversion: b = 0.16; neuroticism: b = -0.21).
# The slopes for extraversion and neuroticism varied across individuals (SDs = 0.14 and 0.19, respectively), indicating individual differences in how these traits relate to SWL.

```

#### Model Comparisons

```{r}

model.comparison(model1, model2)
# Interpretation:
# - The random slope model (model2) fit significantly better than the fixed slope model (model1).
# - Suggests that the effect of extraversion on life satisfaction varies across individuals, supporting a random slope structure.

model.comparison(model2, model3)
# Interpretation:
# - Model3 (which adds neuroticism as a fixed effect) had substantially better fit than model2.
# - Confirms that neuroticism contributes meaningful additional predictive power for life satisfaction.

model.comparison(model3, model4)
# Interpretation:
# - Model4 (with random slopes for both extraversion and neuroticism) improved fit over model3.
# - These results support modeling heterogeneity in both personality effects and confirm that the strength of both predictors varies across participants.
# - Model4 is the best fitting model.

```

#### Final Model Diagnostics and Summary

```{r}
# --------------------------------------------
# Visualize predicted vs. observed SWL values
# -------------------------------------------
visualize(model4, plot = "model")
# Interpretation:
# Thick black line shows the overall model prediction, while individual lines represent three participants across levels of neuroticism.
# Predicted values align well with observed values, though there is variation across individuals.
# Model captures both the overall positive association between extraversion and SWL and individual deviations around that trend.


# ------------------------------------------------
# Visualize residuals to assess model assumptions
# ------------------------------------------------
visualize(model4, plot = "residuals")

# Interpretation:
# Top-left (Histogram of Residuals):
# - Residuals are approximately normally distributed with a slight positive skew.
# - Supports the assumption of normality in residuals.

# Top-right (Residual Dependence Plot):
# - Residuals are generally centered around zero but show a distinct funnel shape.
# - Indicates potential heteroscedasticity — variance appears to decrease as predicted SWL increases.

# Bottom (S-L Plot: Spread vs. Level):
# - The spread of absolute residuals decreases as fitted values increase.
# - Minor heteroscedasticity; residuals are more dispersed at lower predicted SWL values.


# ------------------------
# View full model summary
# ------------------------
summary(model4)

# Interpretation:
# Fixed Effects:
# - Intercept = 4.51: Average SWL when extraversion and neuroticism are at zero.
# - tipm.E (extraversion) = 0.16: Higher extraversion is associated with greater SWL (b = 0.16, SE = 0.02, t = 10.55).
# - tipm.N (neuroticism) = -0.21: Higher neuroticism is linked to lower SWL (b = -0.21, SE = 0.02, t = -12.32).
# - Both predictors are highly significant, supporting H1 and H2!

# Random Effects:
# - Participants varied in their baseline SWL (Intercept SD = 1.42).
# - There is variability in how extraversion (SD = 0.14) and neuroticism (SD = 0.19) relate to SWL across individuals.

# Residual variance is 0.49

# Model fit:
# - REML = 10344.5. Lower REML is better, and this model performed best during comparisons.
# - Convergence warning: Model converged, but the gradient was close to the threshold (max|grad| = 0.00265 vs tol = 0.002). This suggests near-convergence but not a critical issue. If it weren't in the instructions to ignore, I would consider refitting with a different optimizer.


# ----------------------------------
# Extract fixed effects estimates 
# ----------------------------------
model4 <- lmer(swl ~ tipm.E + tipm.N + (tipm.E + tipm.N | id), data = data)

flexplot::estimates(model4)

# Interpretation :
# The average SWL score, when both extraversion and neuroticism are at 0, is about 4.51.

# People who scored higher on extraversion tended to report higher life satisfaction.
# - For each 1-point increase in extraversion, SWL went up by about 0.16 points.

# People who scored higher on neuroticism tended to report lower life satisfaction.
# - For each 1-point increase in Neuroticism, SWL went down by about 0.21 points.

# These effects varied between people:
# - Some people had stronger or weaker links between their personality traits and life satisfaction.

# The ICC was about 0.74. 74.2% of the differences in life satisfaction were due to differences between people (not day-to-day changes). The design effect was about 12.30. That’s quite high, so using a multilevel model (like this one) was definitely the right choice.

# The R-squared values:
# - Fixed effects (R² marginal) explained about 26% of the variation in SWL.
# - The overall model (including random effects) explained even more (R² conditional = not shown here but can be pulled separately).

# NOTE: There was a small warning that the model almost didn’t converge.


# -------------------------------------------------------------
# Extract fixed effects with confidence intervals
# -------------------------------------------------------------
library(broom.mixed)
tidy(model4, effects = "fixed", conf.int = TRUE)

icc(model4)

# ---------------------------------------------
# Get R² estimates (marginal and conditional)
# ---------------------------------------------
library(lmerTest)
library(performance)

r2(model4)

# Conditional R² = 0.788
# - The full model (including fixed effects AND random effects) explains about 79% of the variance in life satisfaction.
# - Most of this explanatory power comes from stable, between-person differences.

# Marginal R² = 0.094
# - The fixed effects (extraversion and neuroticism) explain about 9% of the variance on their own.
# - The rest is explained by individual differences captured by the random effects (e.g., people having their own baselines or slope patterns).

```

## Testing H3: Fit Mixed Effect Model with Within- and Between-person Predictors

H3 states: The effects of personality traits on SWL will be similar at both:

-   Level 1 (within-person, day-to-day changes)

-   Level 2 (between-person, trait averages)

Up to now, model4 let me estimate random slopes (i.e., how the strength of these relationships vary between individuals). But it did NOT test whether the day-to-day (within-person) effects are similar to person-level (between-person) ones.

So to directly test H3, I still need to disaggregate each predictor into its level 1 (within) and level 2 (between) components, fit a new mixed effects model with these decomposed variable, and compare this new model to model4 to see if this more precise decomposition improves fit.

```{r}
# ---------------------------------------------------------------
# Step 1: Disaggregate Predictors to Test H3 (Within vs Between)
# ---------------------------------------------------------------

# This separates each personality variable into:
# - Between-person (mean across all days for each person)
# - Within-person (deviation from that mean on a specific day)

data <- data %>%
  group_by(id) %>%
  mutate(
    extraversion_mean = mean(tipm.E, na.rm = TRUE),       # Between-person Extraversion
    neuroticism_mean = mean(tipm.N, na.rm = TRUE),        # Between-person Neuroticism
    extraversion_wp = tipm.E - extraversion_mean,         # Within-person Extraversion
    neuroticism_wp = tipm.N - neuroticism_mean            # Within-person Neuroticism
  ) %>%
  ungroup()

# --------------------------------------------------------
# Step 2: Fit Model 5 – Disaggregated Predictors Model
# --------------------------------------------------------

model5 <- lmer(
  swl ~ extraversion_wp + extraversion_mean +
        neuroticism_wp + neuroticism_mean +
        (1 | id),
  data = data
)

# This model includes both within-person and between-person predictors.
# The random intercept accounts for individual baseline differences in SWL.

# --------------------------------------------------------
# Step 3: Compare Model 5 with Final Model (Model 4)
# --------------------------------------------------------
# Refit model4 using the updated disaggregated dataset
model4_refit <- lmer(
  swl ~ tipm.E + tipm.N + (tipm.E + tipm.N | id),
  data = data  # now includes the disaggregated columns, but model4 doesn't use them
)

# Now compare the two models
model.comparison(model4_refit, model5)

# This tests whether model5 (which includes disaggregated predictors) fits better than model4 (which allowed random slopes but did not disaggregate).
# model4 is still a better fit

# --------------------------------------------------------
# Step 4: Evaluate Model 5 – Coefficients and Diagnostics
# --------------------------------------------------------
# Full model output
summary(model5)                                   

# Interpretation:
# - Intercept = 4.76: When all predictors are at 0, expected SWL is about 4.76.
# - extraversion_wp = 0.15: On days when participants felt more extraverted than usual, they reported higher SWL (b = 0.15, p < .001).
# - extraversion_mean = 0.36: People who were more extraverted on average also reported higher SWL overall (b = 0.36, p < .001).
# - neuroticism_wp = -0.22: On days participants felt more neurotic than usual, their SWL decreased (b = –0.22, p < .001).
# - neuroticism_mean = -0.52: Participants who were more neurotic on average also reported lower SWL (b = –0.52, p < .001).
# - All effects were statistically significant and in the expected direction.
# - Suggests that both daily fluctuations and stable personality traits are related to life satisfaction.

# Extract fixed effects with 95% confidence intervals
tidy(model5, effects = "fixed", conf.int = TRUE)  

# Interpretation:
# - The CIs don't cross zero for any predictor.

# Calculate ICC (proportion of variance due to ID)
icc(model5)                                       

# Interpretation:
# - Adjusted ICC = 0.69: About 69% of the variance in SWL is due to stable between-person differences.
# - This further supports the need for multilevel modeling to account for clustering by participant.

# Calculate R² for fixed effects and full model
r2(model5)                                        

# Interpretation:
# - Marginal R² = 0.305: About 30.5% of the variance is explained by the fixed effects alone (the predictors).
# - Conditional R² = 0.785: The full model (fixed + random effects) explains ~78.5% of the variance in SWL.
# - The random intercepts (i.e., person-level differences) add a substantial amount of explanatory power.
```
